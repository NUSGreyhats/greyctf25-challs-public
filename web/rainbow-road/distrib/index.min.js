const t=require("socket.io").Server,n=require("fs"),e=require("pngjs").PNG,o=new Map,r=[];let a;async function s(){const t=r[0].length,n=r.length,e=2*t+1,o=2*n+1,s=Array.from({length:o},(()=>Array(e).fill(!1)));for(let t=0;t<o;t++)for(let n=0;n<e;n++)t%2!=1&&n%2!=1||(s[t][n]=!0);const i=Array.from({length:n},(()=>Array(t).fill(!1))),c=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}];function f(e,o){return e>=0&&e<t&&o>=0&&o<n}const h=[{x:0,y:0}];for(i[0][0]=!0,s[1][1]=!1;h.length>0;){const{x:t,y:n}=h[h.length-1],e=c.sort((()=>Math.random()-.5));let o=!1;for(const{dx:r,dy:a}of e){const e=t+r,c=n+a;if(f(e,c)&&!i[c][e]){const f=2*t+r+1,l=2*n+a+1;s[2*c+1][2*e+1]=!1,s[l][f]=!1,i[c][e]=!0,h.push({x:e,y:c}),o=!0;break}}o||h.pop()}for(let r=1;r<n-1;r++)for(let n=1;n<t-1;n++){if(Math.random()<.1){const t=2*n,a=2*r+1;t<e&&a<o&&(s[a][t]=!1)}if(Math.random()<.1){const t=2*n+1,a=2*r;t<e&&a<o&&(s[a][t]=!1)}}for(let t=0;t<o;t++)s[t][200]=!0;a=s}function i(t,n){return!(n<0||n>=r.length||t<0||t>r[0].length)}function c(t,n,e=10){const o=2*e-1,s=2*o+1,i=[],c=[];for(let a=0;a<o;a++){const s=[],c=n-(e-1)+a;for(let n=0;n<o;n++){const o=t-(e-1)+n;c>=0&&c<r.length&&o>=0&&o<r[0].length?s.push(r[c][o]):s.push("")}i.push(s)}for(let e=0;e<s;e++){const o=[],r=2*n-(s>>1)+2+e;for(let n=0;n<s;n++){const e=2*t-(s>>1)+2+n;r>=0&&r<a.length&&e>=0&&e<a[0].length?o.push(a[r][e]):o.push(!1)}c.push(o)}return{walls:c,colors:i}}const f=new t({cors:{origin:"production"===process.env.NODE_ENV?void 0:"http://localhost:5173"}});function h(t,n,e){const{x:s,y:f}=t,h=o.get(n.id);var l,d,u,p;s>=0&&s<r[0].length&&f>=0&&f<r.length&&(l=s,d=f,u=h?.x,p=h?.y,!(Math.abs(l-u)+Math.abs(d-p)>1))&&function(t,n,e,o){if(!i(t,n)||!i(e,o))return!1;const r=t+e+1,s=n+o+1;return!a.at(s)?.at(r)}(s,f,h?.x,h?.y)&&(o.set(n.id,{x:s,y:f}),n.emit("mazeUpdate",c(s,f)),e&&e(!0))}function l(t){o.delete(t.id)}function d(t,n,e){return"#"+t.toString(16).padStart(2,"0")+n.toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")}function u(t){const n=t.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);if(!n)throw new Error(`Invalid hex color: ${t}`);return{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}}var p;p=function(){f.on("connection",(t=>{o.set(t.id,{x:0,y:0}),t.emit("mazeUpdate",c(0,0)),t.on("move",((n,e)=>h(n,t,e))),t.on("restart",(()=>function(t){o.set(t.id,{x:0,y:0}),t.emit("mazeUpdate",c(0,0))}(t))),t.on("endGame",(()=>l(t))),t.on("disconnect",(()=>l(t)))})),setInterval((async()=>{await s();for(const[t,n]of o.entries())f.to(t).emit("mazeUpdate",{isTimer:!0,...c(n.x,n.y)})}),5e3)},n.createReadStream("flag-out.png").pipe(new e).on("parsed",(function(){for(let t=0;t<this.height;t++){const n=[];for(let e=0;e<this.width;e++){const o=this.width*t+e<<2,r=this.data[o],a=this.data[o+1],s=this.data[o+2];n.push(d(r,a,s))}r.push(n)}s().then((()=>{!function(t,o=!1){if(!o)return void t();const s=a.length,i=a[0].length,c=new e({width:i,height:s});function f(t,n,e,o,r){if(t<0||t>=i||n<0||n>=s)return;const a=i*n+t<<2;c.data[a]=e,c.data[a+1]=o,c.data[a+2]=r,c.data[a+3]=255}for(let t=0;t<s;t++)for(let n=0;n<i;n++)if(a[t][n]||n%2+t%2==0)f(n,t,0,0,0);else if(t%2==0&&n%2==0){const e=n/2,o=r[t/2][e],{r:a,g:s,b:i}=u(o);f(n,t,a,s,i)}else{let e;if(t%2==1&&n%2==0?t>0&&(e=r[(t-1)/2][n/2]):t%2==0&&n%2==1?n>0&&(e=r[t/2][(n-1)/2]):t%2==1&&n%2==1&&t>0&&n>0&&(e=r[(t-1)/2][(n-1)/2]),e){const{r:o,g:r,b:a}=u(e);f(n,t,o,r,a)}else f(n,t,0,0,0)}const h=n.createWriteStream("maze.png");c.pack().pipe(h),h.on("finish",(()=>{t()}))}(p,!1)}))})),f.listen(4e3);
